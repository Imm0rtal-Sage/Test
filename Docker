---
- name: "Config wartch of mashines"
  hosts: localhost
  become: yes
  tasks:
   - name: Add Debian Hosts
     add_host:
       hostname: '{{ item }}'
       groups: Debian
       ansible_ssh_user: root
       ansible_ssh_pass: toor
       ansible_host_key_checking: false
     loop:
     - PJD-01
     - PJD-02

   - name: Add CentOS Hosts
     add_host:
       hostname: '{{ item }}'
       groups: Centos
       ansible_ssh_user: root
       ansible_ssh_pass: toor
       ansible_host_key_checking: false
     loop:
     - PJC-01
     - PJC-02

- name: update cache and isntall package
  hosts: all
  tasks:
   - name: add docker repo
     command: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
     when: "'Centos' in group_names"

   - name: install docker-ce on Centos
     shell: yum install docker-ce --nobest --skip-broken
     when: "'Centos' in group_names"

   - name: run docker service
     shell: systemctl enable --now docker.service
     when: "'Debian' in group_names"

   - name: run docker socket
     shell: systemctl enable --now docker.socket
     when: "'Debian' in group_names"

   - name: Create directory for nginx
     file:
        path: /skillcloud-nginx
        state: directory

   - name: copy sh script
     copy:
        src: /skill_hmao/docker-compose.sh
        dest: /skillcloud-nginx

   - name: run docker sh script
     shell: sh /docker-compose.sh

   - name: Create a directory /skillcloud-nginx/{site,balance}
     file:
       path: /skillcloud-nginx/{{ item }}
       state: directory
     loop:
       - site
       - balance

   - name: Copying files needed to build images
     copy:
       src: /skill_hmao/{{ item.src }}
       dest: /skillcloud-nginx/{{ item.dest }}/Dockerfile
     loop:
       - { src: Dockerfile-site, dest: site }
       - { src: Dockerfile-balance, dest: balance }
   - name: Copying files needed to build images
     copy:
       src: /skill_hmao/{{ item.src }}
       dest: /skillcloud-nginx/{{ item.dest }}
     loop:
       - { src: index.html, dest: site }
       - { src: nginx.conf, dest: balance }

   - name: Build images on a VM using Dockerfile in the skillcloud-nsinx directory
     docker_image:
       name: "{{ item.name }}"
       build:
         path: /skillcloud-nginx/{{ item.path }}
     loop:
       - { name: site, path: site }
       - { name: balance, path: balance }

   - name: docker-compose up
     shell:
        cmd: docker-compose -f docker-compose.yml up -d
        chdir: /skillcloud-nginx

   - name: Restart Firewalld
     service:
        name: firewalld
        state: restarted

   - name: Restart ssh/sshd
     service:
        name: "{{ item }}"
        state: restarted
     loop:
         - ssh
         - sshd

   - name: "Rebiit nachines"
     reboot:
