---
- name: "Config wartch of mashines"
  hosts: localhost
  become: yes
  tasks:
   - name: Git Clone
     git:
      repo: https://github.com/andgabs/skill_hmao
      dest: /skill_hmao
      clone: yes

   - name: "Copy to skillcloud-nginx"
     copy:
        src: /skill_hmao/{{ item }}
        dest: /skillcloud-nginx/{{ item }}
     loop:
        - docker-compose.sh
        - docker-compose.yml
        - Dockerfile-balance
        - Dockerfile-site
        - index.html
        - nginx.conf

   - name: Decrypt Users File
     shell: ansible-vault decrypt --vault-id /skill_hmao/hmao-yarulin/password /skill_hmao/Users/privvars.yml

   - name: Add Debian Hosts
     add_host:
       hostname: '{{ item }}'
       groups: Debian
       ansible_ssh_user: root
       ansible_ssh_pass: toor
       ansible_host_key_checking: false
     loop:
     - PJD-01
     - PJD-02

   - name: Add CentOS Hosts
     add_host:
       hostname: '{{ item }}'
       groups: Centos
       ansible_ssh_user: root
       ansible_ssh_pass: toor
       ansible_host_key_checking: false
     loop:
     - PJC-01
     - PJC-02

- name: update cache and isntall package
  hosts: all
  tasks:
   - name: Test Connection
     ping:

   - name: Update Debian
     apt: 
       update_cache: true
     when: "'Debian' in group_names"

   - name: Update CentOS
     yum: 
       update_cache: true
     when: "'Centos' in group_names"

   - name: "Include Vars From software.yaml"
     include_vars: /skill_hmao/software.yaml

   - name: "Install software from file for Debian"
     apt:
      name: "{{ software }}"
      update_cache: yes
     when: "'Debian' in group_names"

   - name: "Install software from file for Centos"
     yum:
      name: "{{ software }}"
      update_cache: yes
     when: "'Centos' in group_names"

   - name: Include Vars From privvars.yml
     include_vars:
        file: /skill_hmao/Users/privvars.yml

   - name: Add Usres From privvars.yml
     user:
        name: "{{ item.0 }}"
        password: "{{ item.1 | password_hash('sha512')}}"
     with_together:
         - "{{ skillcloud.users }}"
         - "{{ skillcloud.passwords }}"

   - name: add authorized key to user
     authorized_key:
        user: "{{ item.0 }}"
        state: present
        key: "{{ skillcloud.publickey }}"
     with_together:
        - "{{ skillcloud.users }}"

   - name: Install Debian
     apt: 
      name: "{{ item }}"
     loop:
         - docker
         - docker-compose
         - firewalld
         - nginx
         - python3-pip
         - python3-setuptools
     when: "'Debian' in group_names"

   - name: Install CentOS
     yum: 
      name: "{{ item }}"
     loop:
         - docker
         - firewalld
         - nginx
         - yum-utils
         - python3-pip
         - python3-setuptools
     when: "'Centos' in group_names"

   - name: Firewalld Enable
     service:
        name: firewalld
        state: started
        enabled: yes

   - name: Firewalld Port
     firewalld:
         zone: public
         port: "{{ item }}"
         permanent: true
         immediate: true
         state: enabled
     loop:
         - 80/tcp
         - 8080/tcp
         - 1022/tcp

   - name: Configure SSH server
     lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
     loop:
        - { regexp: '^#?#Port.*', line: 'Port 1022' }
        - { regexp: '^#?#PubkeyAuthentication.*', line: 'PubkeyAuthentication yes' }

   - name: copy sh script
     copy:
        src: /skill_hmao/docker-compose.sh
        dest: /

   - name: run docker sh script
     shell: sh /docker-compose.sh

   - name: add docker repo
     command: yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
     when: "'Centos' in group_names"

   - name: install docker-ce on Centos
     shell: yum install docker-ce --nobest --skip-broken
     when: "'Centos' in group_names"

   - name: run docker service
     shell: systemctl enable --now docker.service
     when: "'Debian' in group_names"

   - name: run docker socket
     shell: systemctl enable --now docker.socket
     when: "'Debian' in group_names"

   - name: Create directory for nginx
     file:
        path: /skillcloud-nginx
        state: directory

   - name: "Copy to skillcloud-nginx"
     copy:
        src: /skillcloud-nginx
        dest: /skillcloud-nginx

   - name: Image Site
     docker_image:
        name: Site
        repository: /skillcloud-nginx/Dockerfile-site
        push: true
        source: local

   - name: docker-compose up
     shell:
        cmd: docker-compose -f docker-compose.yml up -d
        chdir: /skillcloud-nginx

   - name: Restart Firewalld
     service:
        name: firewalld
        state: restarted

   - name: Restart ssh/sshd
     service:
        name: "{{ item }}"
        state: restarted
     loop:
         - ssh
         - sshd

   - name: "Rebiit nachines"
     reboot:
